(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{677:function(e,s,t){},678:function(e,s,t){},679:function(e,s){e.exports=function(e){e.options.__i18n=e.options.__i18n||[],e.options.__i18n.push('{"zh-CN":{"version":"版本号","currentVersion":"当前版本","scheme":"方案","historicVersion":"历史版本","tuckUp":"Tuck up","more":"more...","saveBtnText":"保存版本","cancelBtnText":"取消"},"en":{"version":"Version","currentVersion":"Current version","scheme":"Scheme","historicVersion":"Historic version","tuckUp":"Tuck up","more":"more...","saveBtnText":"Save","cancelBtnText":"Cancel"}}'),delete e.options._Ctor}},911:function(e,s,t){"use strict";var r=t(677);t.n(r).a},912:function(e,s,t){"use strict";var r=t(678);t.n(r).a},913:function(e,s,t){"use strict";var r=t(679),a=t.n(r);s.default=a.a},973:function(e,s,t){"use strict";t.r(s);var r=function(){var e=this,s=e.$createElement,t=e._self._c||s;return null!==e.release?t("div",{staticClass:"release-add-wrapper"},[t("release-editor-layout",{attrs:{release:e.release,type:"add"},on:{"update:release":function(s){e.release=s}}},[t("template",{slot:"about-version"},[t("div",{staticClass:"r-a-w-version"},[t("h4",[e._v(e._s(e.$t("version")))]),e._v(" "),t("div",{staticClass:"r-a-w-v-current"},[t("label",[e._v(e._s(e.$t("currentVersion")))]),e._v(" "),t("el-input",{model:{value:e.newVersion,callback:function(s){e.newVersion=s},expression:"newVersion"}}),e._v(" "),e.resourceDetail?t("div",{staticClass:"raw-v--li-name"},[t("img",{class:{"resource-default-preview":!(e.resourceDetail.previewImages&&e.resourceDetail.previewImages[0])},attrs:{src:e.resourceDetail.previewImages?e.resourceDetail.previewImages[0]:"",alt:""}}),e._v("\n            "+e._s(e.resourceDetail.aliasName)+"\n          ")]):e._e()],1),e._v(" "),t("div",{staticClass:"r-a-w-v-list clearfix"},[t("label",[e._v(e._s(e.$t("historicVersion")))]),e._v(" "),t("div",{staticStyle:{"margin-left":"72px"}},[t("ul",{staticClass:"raw-v--ul"},e._l(e.targetVersionsList,function(s){return t("li",[t("div",{staticClass:"raw-v--li-box"},[t("span",{staticClass:"raw-v--li-version"},[e._v(e._s(s.version))]),e._v(" "),t("span",{staticClass:"raw-v--li-date"},[e._v("("+e._s(s.createDate)+")")])]),e._v(" "),t("div",{staticClass:"raw-v--li-name"},[t("img",{class:{"resource-default-preview":!(s.previewImages&&s.previewImages[0])},attrs:{src:s.previewImages?s.previewImages[0]:"",alt:""}}),e._v("\n                  "+e._s(s.aliasName)+"\n                ")])])}),0),e._v(" "),e.release.resourceVersions.length>3?t("div",{staticClass:"r-a-w-v-l-more",on:{click:e.tapMoreBtn}},[e._v("\n              "+e._s(this.isShowAllVersions?e.$t("tuckUp"):e.$t("more"))+"\n            ")]):e._e()])])]),e._v(" "),e.depReleasesList.length>0?t("div",{staticClass:"r-a-w-scheme"},[t("div",{staticClass:"r-a-w-s-line"}),e._v(" "),t("h4",[e._v(e._s(e.$t("scheme")))]),e._v(" "),t("scheme-manage",{attrs:{type:"add",release:e.release,baseUpcastReleases:e.release.baseUpcastReleases,depReleasesList:e.depReleasesList,depReleasesDetailList:e.depReleasesDetailList},on:{"update:depReleasesDetailList":function(s){e.depReleasesDetailList=s},"update:dep-releases-detail-list":function(s){e.depReleasesDetailList=s},"update-resolved-releases":e.updateResolvedReleases}})],1):e._e(),e._v(" "),t("div",{staticClass:"r-a-w-footer",class:{"no-scheme":0===e.depReleasesList.length}},[t("div",{staticClass:"r-a-w-cancel-btn",on:{click:e.cancelAddRelease}},[e._v(e._s(e.$t("cancelBtnText")))]),e._v(" "),t("div",{staticClass:"r-a-w-save-btn",on:{click:e.saveReleaseVersion}},[e._v(e._s(e.$t("saveBtnText")))])])])],2)],1):e._e()};r._withStripped=!0;var a=t(87),i=t.n(a),n=t(747),o=t(522),c=t(134),l=t(26),u={name:"release-add-box",components:{SchemeManage:o.a,ReleaseEditorLayout:n.a},data:function(){return{releaseId:this.$route.query.releaseId,resourceId:this.$route.query.resourceId,release:null,resourceDetail:null,releaseScheme:null,depReleasesList:[],depReleasesDetailList:[],releasesTreeData:[],resolvedReleases:[],targetVersionsList:[],newVersion:"",isShowAllVersions:!1}},computed:{},watch:{isShowAllVersions:function(){this.getTargetVersionsList()}},methods:{fetchResourceDetail:function(){var e=this;this.$services.resource.get(this.resourceId).then(function(e){return e.data}).then(function(s){0===s.errcode?(e.resourceDetail=s.data,e.depReleasesList=s.data.systemMeta.dependencies||[],e.releaseName=s.data.aliasName):e.$message({type:"error",message:s.msg})}).catch(function(s){return e.$message({type:"error",message:s.toString()})})},fetchReleaseDetail:function(){var e=this;this.$services.ReleaseService.get(this.releaseId).then(function(e){return e.data}).then(function(s){0===s.errcode&&(e.release=s.data,e.formatReleaseData(),e.fetchEveryVersionRDetail())})},fetchReleaseScheme:function(){var e=this,s=this.release,t=s.releaseId,r=s.latestVersion.version;this.$services.ReleaseService.get("".concat(t,"/versions/").concat(r)).then(function(e){return e.data}).then(function(s){0===s.errcode&&(e.releaseScheme=s.data)}).catch(function(s){return e.$error.showErrorMessage("授权方案获取失败！")})},formatReleaseData:function(){this.newVersion=this.getNewVersion(),this.release.resourceVersions=this.release.resourceVersions.map(function(e){return e.createDate=Object(c.format)(e.createDate,"YYYY-MM-DD"),e}),this.getTargetVersionsList()},fetchEveryVersionRDetail:function(){var e=this;this.$services.resource.get("list",{params:{resourceIds:this.release.resourceVersions.map(function(e){return e.resourceId}).join(","),projection:"aliasName,resourceId,resourceType,createDate,intro,previewImages"}}).then(function(e){return e.data}).then(function(s){if(0===s.errcode){var t={};s.data=s.data.forEach(function(e){return t[e.resourceId]=e}),e.release.resourceVersions=e.release.resourceVersions.sort(l.e).map(function(e){return(e=Object.assign(e,t[e.resourceId])).createDate=Object(c.format)(e.createDate,"YYYY-MM-DD"),e}),e.getTargetVersionsList()}else e.$message({type:"error",message:s.msg})}).catch(function(s){return e.$message({type:"error",message:s.toString()})})},getTargetVersionsList:function(){this.isShowAllVersions?this.targetVersionsList=this.release.resourceVersions.slice():this.targetVersionsList=this.release.resourceVersions.slice(0,3)},getNewVersion:function(){var e=this.release.latestVersion.version.split("."),s=i()(e,3),t=s[0],r=s[1],a=s[2];return a=+a+1,"".concat(t,".").concat(r,".").concat(a)},tapMoreBtn:function(){this.isShowAllVersions=!this.isShowAllVersions},updateResolvedReleases:function(e){this.resolvedReleases=e},cancelAddRelease:function(){this.$router.go(-1)},saveReleaseVersion:function(){var e=this;this.$axios.post("/v1/releases/".concat(this.releaseId,"/versions"),{resourceId:this.resourceId,version:this.newVersion,resolveReleases:this.resolvedReleases}).then(function(e){return e.data}).then(function(s){0===s.errcode?e.$router.replace("/release/edit/".concat(e.releaseId)):e.$error.showErrorMessage(s.msg)})}},created:function(){this.fetchReleaseDetail(),this.fetchResourceDetail()}},v=(t(911),t(912),t(3)),d=t(913),h=Object(v.a)(u,r,[],!1,null,"16bb2532",null);"function"==typeof d.default&&Object(d.default)(h),h.options.__file="src/views/release/add/index.vue";s.default=h.exports}}]);